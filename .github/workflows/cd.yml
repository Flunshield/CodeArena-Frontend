name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  test:
     runs-on: ubuntu-latest

     steps:
       - name: ⏳ Checkout du code
         uses: actions/checkout@v2

       - name: ⏳ Récupérer la variable d'environnement VITE_API_BASE_URL_BACK
         env:
           VITE_API_BASE_URL_BACK: ${{ secrets.VITE_API_BASE_URL_BACK }}
         run: echo "VITE_API_BASE_URL_BACK=${VITE_API_BASE_URL_BACK}" >> .env

       - name: ⏳ Afficher le contenu du fichier .env
         run: cat .env

       - name: 🚧 Cache node modules
         id: cache-npm
         uses: actions/cache@v3
         env:
           cache-name: cache-node-modules
         with:
           path: ~/.npm
           key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
           restore-keys: |
             ${{ runner.os }}-build-${{ env.cache-name }}-
             ${{ runner.os }}-build-
             ${{ runner.os }}-

       - if: ${{ steps.cache-npm.outputs.cache-hit != 'true' }}
         name: ⏳ List the state of node modules
         continue-on-error: true
         run: npm list

       - name: ⏳ Install dependencies
         run: npm install

       - name: ⏳ Lintage du code
         run: npm run lint

       - name: 🚀 Lancement du projet en arrière-plan
         run: |
           npm run dev &
           sleep 30  # Attendre quelques secondes pour que le projet démarre complètement

       - name: 🚧 Exécuter les tests
         run: |
           npx cypress run

       - name: Obtenir le type de changement du dernier commit
         id: get_commit_type
         run: |
           COMMIT_MESSAGE=$(git log --format="%s" -n 1)
           if echo "$COMMIT_MESSAGE" | grep -qE '\[(minor|major|patch)\]'; then
             CHANGE_TYPE=$(echo "$COMMIT_MESSAGE" | grep -oE '\[(minor|major|patch)\]' | sed 's/[][]//g')
           else
             CHANGE_TYPE="patch"  # Si aucun type n'est spécifié, utiliser "patch" par défaut
           fi
           echo "::set-output name=type::$CHANGE_TYPE"

       - name: Génération du changelog et mise à jour de la version
         run: |
           # Obtenir le type de changement à partir du commit
           CHANGE_TYPE="${{ steps.get_commit_type.outputs.type }}"
           # Exécuter la commande npm version en fonction du type de changement
           npm version $CHANGE_TYPE
            
  deploy:
    if: ${{ github.ref == 'refs/heads/main' && needs.test.result == 'success' }}
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name:  ⏳ Checkout du code
        uses: actions/checkout@v2

      - name:  ⏳ Récupérer la variable d'environnement VITE_API_BASE_URL_BACK
        env:
          VITE_API_BASE_URL_BACK: ${{ secrets.VITE_API_BASE_URL_BACK }}
        run: echo "VITE_API_BASE_URL_BACK=${VITE_API_BASE_URL_BACK}" >> .env

      - name: 🚀 Déploiement sur le VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd front-app/
            docker compose down
            git pull
            docker compose up --build -d
